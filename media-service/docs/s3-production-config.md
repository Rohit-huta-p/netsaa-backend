# NETSA S3 Production Configuration

> **Bucket**: `netsa-media-prod`  
> **Region**: `ap-south-1` (Mumbai)  
> **Purpose**: User-generated content (profile images, gig media, event banners)

---

## 1. Bucket-Level Settings

| Setting | Value | Rationale |
|---------|-------|-----------|
| **Versioning** | ❌ Disabled | Not needed for media files; reduces storage costs |
| **Encryption at Rest** | ✅ SSE-S3 (AES-256) | AWS-managed encryption, no extra cost |
| **Object Ownership** | Bucket owner enforced | Required to disable ACLs |
| **ACLs** | ❌ Disabled | All access controlled via bucket policy only |
| **Object Lock** | ❌ Disabled | Not needed for user media |

### AWS Console Path
`S3 → netsa-media-prod → Properties`

---

## 2. Block Public Access Settings

> [!IMPORTANT]
> This is the most critical security configuration.

| Setting | Value | Reason |
|---------|-------|--------|
| **Block public access to buckets and objects granted through *new* ACLs** | ✅ ON | ACLs are disabled anyway |
| **Block public access to buckets and objects granted through *any* ACLs** | ✅ ON | ACLs are disabled anyway |
| **Block public access to buckets and objects granted through *new* public bucket policies** | ❌ OFF | We need our bucket policy to work |
| **Block public access granted through *any* public bucket policies** | ❌ OFF | We need our bucket policy to work |

### Why This Is Safe

1. **ACL blocks are ON** → No one can use ACLs to make objects public
2. **Policy blocks are OFF** → Our explicit bucket policy controls all access
3. **Bucket policy is restrictive** → Only allows `GetObject` (read), not `PutObject/DeleteObject`

### AWS CLI Command to Set
```bash
aws s3api put-public-access-block \
  --bucket netsa-media-prod \
  --public-access-block-configuration \
  "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=false,RestrictPublicBuckets=false"
```

---

## 3. Bucket Policy (Production)

> [!CAUTION]
> This policy allows **public read ONLY**. No write, no delete, no listing.

```json
{
  "Version": "2012-10-17",
  "Id": "NetsaMediaPublicReadPolicy",
  "Statement": [
    {
      "Sid": "AllowPublicRead",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::netsa-media-prod/*"
    }
  ]
}
```

### What This Policy Does

| Action | Allowed? | Notes |
|--------|----------|-------|
| `s3:GetObject` (download/view) | ✅ Yes | Anyone can view media via direct URL |
| `s3:PutObject` (upload) | ❌ No | Only via pre-signed URLs (IAM credentials) |
| `s3:DeleteObject` (delete) | ❌ No | Only via IAM credentials |
| `s3:ListBucket` (list contents) | ❌ No | No one can enumerate bucket contents |
| `s3:GetBucketPolicy` | ❌ No | Bucket policy not readable |

### What This Means

- **Users can view media** at `https://netsa-media-prod.s3.ap-south-1.amazonaws.com/{key}`
- **Uploads require pre-signed URLs** generated by media-service
- **No one can list all files** in the bucket
- **No one can delete files** without IAM credentials

---

## 4. Region Configuration

All three must match for pre-signed URLs to work correctly:

| Component | Region | Status |
|-----------|--------|--------|
| **S3 Bucket** | `ap-south-1` | Set in AWS Console |
| **SDK Client** | `ap-south-1` | Set via `AWS_REGION` env var |
| **Pre-signed URLs** | `ap-south-1` | Inherited from SDK client |

### Verification
```bash
# Check bucket region
aws s3api get-bucket-location --bucket netsa-media-prod

# Expected output:
# { "LocationConstraint": "ap-south-1" }
```

### SDK Configuration (already in code)
```typescript
// media-service/src/config/s3.ts
export const s3Client = new S3Client({
    region: env.aws.region,  // Must be ap-south-1
    credentials: { ... },
});
```

---

## 5. CORS Configuration

> [!IMPORTANT]
> CORS is **required** for browser-based uploads using pre-signed URLs. Without it, browsers will block the PUT request.

### Production CORS Policy

```json
[
  {
    "ID": "AllowFrontendUploads",
    "AllowedOrigins": [
      "https://netsa.app",
      "https://www.netsa.app",
      "https://admin.netsa.app"
    ],
    "AllowedMethods": [
      "GET",
      "PUT",
      "HEAD"
    ],
    "AllowedHeaders": [
      "Content-Type",
      "Content-Length",
      "x-amz-acl",
      "x-amz-meta-*"
    ],
    "ExposeHeaders": [
      "ETag",
      "x-amz-meta-*"
    ],
    "MaxAgeSeconds": 3600
  }
]
```

### Development CORS Policy

For local development, use a more permissive policy:

```json
[
  {
    "ID": "AllowLocalDevelopment",
    "AllowedOrigins": [
      "http://localhost:3000",
      "http://localhost:8081",
      "http://localhost:19006",
      "exp://192.168.*.*:*"
    ],
    "AllowedMethods": [
      "GET",
      "PUT",
      "HEAD"
    ],
    "AllowedHeaders": [
      "*"
    ],
    "ExposeHeaders": [
      "ETag"
    ],
    "MaxAgeSeconds": 3600
  }
]
```

### What Each Setting Does

| Setting | Value | Purpose |
|---------|-------|---------|
| **AllowedOrigins** | Your frontend domains | Only these origins can make requests |
| **AllowedMethods** | GET, PUT, HEAD | GET for downloads, PUT for uploads, HEAD for checks |
| **AllowedHeaders** | Content-Type, etc. | Headers the browser can send |
| **ExposeHeaders** | ETag | Headers the browser can read from response |
| **MaxAgeSeconds** | 3600 | Cache preflight response for 1 hour |

### AWS CLI Command (Production)

```bash
aws s3api put-bucket-cors \
  --bucket netsa-media-prod \
  --cors-configuration '{
    "CORSRules": [
      {
        "ID": "AllowFrontendUploads",
        "AllowedOrigins": ["https://netsa.app", "https://www.netsa.app"],
        "AllowedMethods": ["GET", "PUT", "HEAD"],
        "AllowedHeaders": ["Content-Type", "Content-Length", "x-amz-acl", "x-amz-meta-*"],
        "ExposeHeaders": ["ETag", "x-amz-meta-*"],
        "MaxAgeSeconds": 3600
      }
    ]
  }'
```

### AWS CLI Command (Development)

```bash
aws s3api put-bucket-cors \
  --bucket netsa-media-dev \
  --cors-configuration '{
    "CORSRules": [
      {
        "ID": "AllowLocalDevelopment",
        "AllowedOrigins": ["http://localhost:3000", "http://localhost:8081", "http://localhost:19006"],
        "AllowedMethods": ["GET", "PUT", "HEAD"],
        "AllowedHeaders": ["*"],
        "ExposeHeaders": ["ETag"],
        "MaxAgeSeconds": 3600
      }
    ]
  }'
```

### Verify CORS Configuration

```bash
# Check current CORS config
aws s3api get-bucket-cors --bucket netsa-media-prod

# Test CORS preflight (should return CORS headers)
curl -I -X OPTIONS \
  -H "Origin: https://netsa.app" \
  -H "Access-Control-Request-Method: PUT" \
  https://netsa-media-prod.s3.ap-south-1.amazonaws.com/test.jpg
```

### Common CORS Errors

| Error | Cause | Fix |
|-------|-------|-----|
| `No 'Access-Control-Allow-Origin' header` | Origin not in AllowedOrigins | Add your domain to the list |
| `Method PUT is not allowed` | PUT not in AllowedMethods | Add PUT to AllowedMethods |
| `Request header field X is not allowed` | Header not in AllowedHeaders | Add the header or use `*` |

---

## 6. Lifecycle Rules

### Rule 1: Abort Incomplete Multipart Uploads (Required)

Prevents orphaned upload parts from accumulating costs.

```json
{
  "Rules": [
    {
      "ID": "AbortIncompleteMultipartUploads",
      "Status": "Enabled",
      "Filter": {},
      "AbortIncompleteMultipartUpload": {
        "DaysAfterInitiation": 7
      }
    }
  ]
}
```

**AWS CLI Command:**
```bash
aws s3api put-bucket-lifecycle-configuration \
  --bucket netsa-media-prod \
  --lifecycle-configuration file://lifecycle.json
```

### Rule 2: Future-Safe Archival (Optional)

For future cost optimization, consider moving old media to cheaper storage:

```json
{
  "ID": "ArchiveOldMedia",
  "Status": "Disabled",
  "Filter": {
    "Prefix": "uploads/"
  },
  "Transitions": [
    {
      "Days": 365,
      "StorageClass": "STANDARD_IA"
    },
    {
      "Days": 730,
      "StorageClass": "GLACIER"
    }
  ]
}
```

> [!NOTE]
> Keep this rule **disabled** for now. Enable when you have significant storage costs.

---

## 7. IAM Policy for Media-Service

The media-service should use an IAM user/role with these minimal permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "MediaServiceS3Access",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::netsa-media-prod/*"
    }
  ]
}
```

**Do NOT include:**
- `s3:ListBucket` (not needed)
- `s3:*` (overly permissive)
- `s3:DeleteBucket` (dangerous)

---

## 8. Production Environment Variables

```bash
# Production .env for media-service
NODE_ENV=production
AWS_REGION=ap-south-1
AWS_S3_BUCKET=netsa-media-prod
PRESIGN_EXPIRY_SECONDS=300  # Shorter for security (5 minutes)
```

---

## 9. Verification Checklist

Use this checklist to verify your configuration in AWS Console:

### S3 → netsa-media-prod → Properties
- [ ] **Bucket Versioning**: Disabled
- [ ] **Default encryption**: SSE-S3 (AES-256)
- [ ] **Object Lock**: Disabled

### S3 → netsa-media-prod → Permissions

- [ ] **Object Ownership**: "Bucket owner enforced" (ACLs disabled)

- [ ] **Block Public Access**:
  - [x] Block public access to buckets and objects granted through *new* ACLs
  - [x] Block public access to buckets and objects granted through *any* ACLs
  - [ ] Block public access granted through *new* public bucket policies
  - [ ] Block public access granted through *any* public bucket policies

- [ ] **Bucket Policy**: Contains only `s3:GetObject` for `Principal: *`

- [ ] **Access Control List**: Disabled (grayed out)

- [ ] **CORS Configuration**: Configured with allowed origins

### S3 → netsa-media-prod → Management
- [ ] **Lifecycle rule**: AbortIncompleteMultipartUploads enabled (7 days)

### IAM → media-service-user
- [ ] **Policy**: Only `s3:PutObject`, `s3:GetObject`, `s3:DeleteObject`
- [ ] **Resource**: Scoped to `arn:aws:s3:::netsa-media-prod/*`

---

## 10. Testing Commands

```bash
# 1. Test public read (should work)
curl -I https://netsa-media-prod.s3.ap-south-1.amazonaws.com/test/sample.jpg
# Expected: 200 OK (if file exists) or 404 (if not)

# 2. Test public write (should FAIL)
curl -X PUT -d "test" https://netsa-media-prod.s3.ap-south-1.amazonaws.com/test/malicious.txt
# Expected: 403 Forbidden

# 3. Test bucket listing (should FAIL)
curl https://netsa-media-prod.s3.ap-south-1.amazonaws.com/
# Expected: 403 AccessDenied

# 4. Test pre-signed URL upload (should work via your API)
# Use your media-service endpoint to generate a pre-signed URL
```

---

## Security Summary

| Attack Vector | Protection |
|---------------|------------|
| **Unauthorized uploads** | Pre-signed URLs required (expire in 5 min) |
| **Unauthorized deletes** | IAM credentials required |
| **Bucket enumeration** | `ListBucket` not allowed |
| **ACL manipulation** | ACLs disabled at bucket level |
| **Policy tampering** | Only admin IAM users can modify |
| **Data at rest** | SSE-S3 encryption enabled |
| **Cross-region issues** | All components use `ap-south-1` |

---

## Quick Reference Commands

```bash
# Set block public access
aws s3api put-public-access-block \
  --bucket netsa-media-prod \
  --public-access-block-configuration \
  "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=false,RestrictPublicBuckets=false"

# Set bucket policy
aws s3api put-bucket-policy \
  --bucket netsa-media-prod \
  --policy '{
    "Version": "2012-10-17",
    "Statement": [{
      "Sid": "AllowPublicRead",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::netsa-media-prod/*"
    }]
  }'

# Enable SSE-S3 encryption
aws s3api put-bucket-encryption \
  --bucket netsa-media-prod \
  --server-side-encryption-configuration '{
    "Rules": [{"ApplyServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]
  }'

# Set lifecycle rule
aws s3api put-bucket-lifecycle-configuration \
  --bucket netsa-media-prod \
  --lifecycle-configuration '{
    "Rules": [{
      "ID": "AbortIncompleteMultipartUploads",
      "Status": "Enabled",
      "Filter": {},
      "AbortIncompleteMultipartUpload": {"DaysAfterInitiation": 7}
    }]
  }'
```
